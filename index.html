<!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <title>D3 Test</title>
            <script type="text/javascript" src="d3/d3.js"></script>
        </head>
        <style type="text/css">
        .bar {
            fill: steelblue;
        }

        .bar:hover {
            fill: brown;
        }

        .axis {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .x.axis path {
            display: none;
        }
        body {
            max-width: 960px;
            margin: auto;
        }

        h2 {
            color: #0F6F9F;
            font-family: Georgia;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            text-decoration: underline;
            letter-spacing: -1px;
            line-height: 34px;
            margin: 0;
        }

        h2.title {
            color: #202020;

        }


        </style>
        <body>

          <div id="svgchart">
              <h2>Airbnb in NYC Price Chart</h2>
<!--               <svg class='svgchart'> -->
          </div>

          <div id="svgmap">
              <h2>Location of Airbnb in NYC</h2>
              <svg class='svgmap'>
          </div>
          <hr>
          <div id="averagechart">
              <h2>Average Price of Airbnb in NYC</h2>
              <svg class='averagechart'>
          </div>

      </body>



          <script type="text/javascript">
          // Your beautiful D3 code will go here
          //https://www.dashingd3js.com/lessons/geojson

          var margin_chart = {top: 10, right: 30, bottom: 60, left: 80},
              width_chart = 960 - margin_chart.left - margin_chart.right,
              width_brush = width_chart ;
              height_chart = 300 - margin_chart.top - margin_chart.bottom,
              height_brush = height_chart ;


          var margin_map = {top: 0, right: 0, bottom: 0, left: 0},
              width_map = 960 - margin_map.left - margin_map.right,
              height_map = 500 - margin_map.top - margin_map.bottom;

          var margin_averagechart = { top: 20, right: 120, bottom: 30, left: 140 },
            width_averagechart = 960 - margin_averagechart.left - margin_averagechart.right,
            height_averagechart = 500 - margin_averagechart.top - margin_averagechart.bottom;


          var svgchart = d3.select("#svgchart")
                          .append("svg")
                          .attr("width", width_chart + margin_chart.left + margin_chart.right)
                          .attr("height", height_chart + margin_chart.top + margin_chart.bottom)
                          .append("g")
                          .attr("transform",
                                  "translate(" + margin_chart.left + "," + margin_chart.top + ")");

          var svgmap = d3.select("#svgmap")
                        .append("svg")
                        .attr("width", width_map)
                        .attr("height", height_map);


          var svgAvgChart = d3.select("#averagechart")
                            .append("svg")
                            .attr("width", width_averagechart + margin_averagechart.left + margin_averagechart.right)
                            .attr("height", height_averagechart + margin_averagechart.top + margin_averagechart.bottom)
                            .append("g")
                            .attr("transform", "translate(" + margin_averagechart.left + "," + margin_averagechart.top + ")");


          var projection = d3.geoMercator().scale(45000).translate([width_map /2, height_map/2]).center([-74.0, 40.7]);
          var path = d3.geoPath().projection(projection);

         // Load in my states data!
            d3.csv("airbnbNYC_2017.csv", function(data) {
               //----------draw histogram------------
               d3.json("boroughs.geojson", function(json) {

                //map
                // Bind the data to the SVG and create one path per GeoJSON feature
                    svgmap.selectAll("path")
                      .data(json.features)
                      .enter()
                      .append("path")
                      .attr("d", path)
                      .style("stroke", "#fff")
                      .style("stroke-width", "1")
                      .style("fill", function(d) {
                          // Get data value
                          var value = d.properties.BoroName;

                          if (value == "Staten Island") {
                            return "rgb(107,174,214)";
                          } else if (value == "Bronx") {
                            return "rgb(213,222,217)";
                          } else if (value == "Manhattan"){
                            return "rgb(222,235,247)";
                          }else if (value == "Brooklyn"){
                            return "rgb(198,219,239)";
                          }else if (value == "Queens"){
                            return "rgb(158,202,225)";
                          }
                        });

                      data.forEach(function(d){
                          d.price = parseInt(d.price);
                        });

                         groupPrice = d3.nest()
                                      .key(function(d) {return d.price})
                                      .rollup(function (v) {return v.length})
                                      .entries(data)
                                      ;
                        console.log(groupPrice);

                        groupPrice.forEach(function(d){
                          d.key = parseInt(d.key);
                        });


                var brush = d3.brushX()
                              .extent([[0, 0], [width_brush, height_brush]])
                              .on("brush", brushed)
                              .on("end", updateData);
                              ;

                function brushed(){
                  if (d3.event.selection != null) {
                      range = d3.brushSelection(this)
                              .map(x.invert);
                  }
                }

              //make new array for selected data
              function updateData(){
                brushedData = [];

                  for (var i = 0 ; i < data.length; i++){
                    if (data[i].price >= range[0] && data[i].price <= range[1]){
                        brushedData.push(data[i]);
                    }
                  };
                  console.log(brushedData);
                  drawCircle();
              }


                var x = d3.scaleLinear()
                          .domain([0, d3.max(groupPrice, function(d) { return d.key; })])
                          .range([0, width_chart]);

                var y = d3.scaleLinear()
                          .range([height_chart, 0])
                          .domain([0, d3.max(groupPrice, function(d) { return d.value; })]);


                // append the bar rectangles to the svg element
                svgchart.selectAll("rect")
                    .data(groupPrice)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .style("fill", "rgb(107,174,214)" )
                    .attr("x", function (d) {return x(d.key) })
                    .attr("y", function (d){ return y(d.value)})
                    .attr("width", 1)
                    .attr("height", function(d) { return height_chart - y(d.value); });



                 var xAxis = d3.axisBottom(x);
                 var yAxis = d3.axisLeft(y);

                 //add brush area box
                 svgchart.append("g")
                      .attr("class", "brush")
                      .call(brush)
                      .call(brush.move, [0, 50].map(x));

                // add the x Axis
                svgchart.append("g")
                    .attr("class", "xAxis")
                    .attr("transform", "translate(0," + height_chart + ")")
                    .call(xAxis);


                // add the y Axis
                svgchart.append("g")
                    .attr("class", "yAxis")
                    .call(yAxis);

                svgchart
                    .append("text")
                    .attr("transform", "translate(-35," + (height_chart + margin_chart.bottom)/1.5 + ") rotate(-90)")
                    .text("# of Aibnb");

                svgchart
                    .append("text")
                    .attr("transform", "translate(" + (width_chart / 2) + "," + (height_chart + margin_chart.bottom) + ")")
                    .text("Price");




                function drawCircle(){
                  //remove all circle first
                  svgmap.selectAll("circle").remove();
                  //console.log(bdata);
                  //draw circle
                  var circles = svgmap.selectAll("circle")
                                .data(brushedData) //change to range of new data
                                .enter()
                                .append("circle")
                                .attr("cx", function(d) {
                                  return projection([d.longitude, d.latitude])[0];
                                })
                                .attr("cy", function(d) {
                                  return projection([d.longitude, d.latitude])[1];
                                })
                                //.attr("class", "non_brushed")
                                .attr("r", 3)
                                  .style("fill",function(d) {
                                    // Get data value
                                    var value = d.price;

                                    if (value  < 50) {
                                      return "red";
                                    } else if (value < 100) {
                                      return "blue";
                                    } else if (value < 200){
                                      return "rgb(217,81,67)";
                                    }else {
                                      return "rgb(200,81,67)";
                                    }
                                  })
                                  .style("opacity", 0.85) ;
                }

              });


            // Group data by neghbourhood
            var groupByNeghbour = d3.nest()
                .key(function (d) { return d.borough; })
                .entries(data);

                console.log(groupByNeghbour);

            groupByNeghbour.forEach(group => {
                group.average = d3.mean(group.values, function (d) {
                    return d.price;
                });
            });

            var xAvgChart = d3.scaleBand()
                .rangeRound([0, width_averagechart], .1)
                .paddingInner(0.1);

            var yAvgChart = d3.scaleLinear()
                .range([height_averagechart, 0]);

            var xAvgChartAxis = d3.axisBottom()
                .scale(xAvgChart);

            var yAvgChartAxis = d3.axisLeft()
                .scale(yAvgChart);

            // Draw Barchar
            xAvgChart.domain(groupByNeghbour.map(function (d) { return d.key; }));
            yAvgChart.domain([0, d3.max(groupByNeghbour, function (d) { return d.average; })]);

            svgAvgChart.append("g")
                // .attr("class", "xAvgChart")
                .attr("transform", "translate(0," + height_averagechart + ")")
                .text("Boroughs")
                .call(xAvgChartAxis);

            svgAvgChart.append("g")
                .attr("class", "yAvgChart")
                .call(yAvgChartAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Price");

            svgAvgChart.selectAll(".bar")
                .data(groupByNeghbour)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d) { return xAvgChart(d.key); })
                .attr("width", xAvgChart.bandwidth())
                .attr("y", function (d) { return yAvgChart(d.average); })
                .attr("height", function (d) { return height_averagechart - yAvgChart(d.average); });
      });

      <div class="w3-container">
        <h3><b>Expliner Page</b></h3>
        <p style="color:grey;">The story behind the project. <span class="w3-opacity"><a href="explainer.html" target="_blank">Expliner: Telling the Stories Behind Data</a></span></p>
      </div>

      <div class="w3-container">
        <h3><b>Github Repo</b></h3>
        <p style="color:grey;">The code of story page and expainer page <span class="w3-opacity"><a href="https://github.com/ninomiyaonion/project-assignment-B" target="_blank">project-assignment-B</a></span></p>
      </div>

            </script>
<!--         </body> -->
</html>
